@page "/pokemongame"
@using PokeMin.Models
@inject HttpClient Http
@inject IJSRuntime JS

@if (pokemonList.Count == 0)
{
    <p>Indl√¶ser Pok√©moner...</p>
}
else if (gameCompleted)
{
    // –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    <div class="game-container results-screen">
        <h2 class="results-title">üéâ Finish!</h2>
        <div class="final-score">
            <p>Result:</p>
            <h3>@score –∏–∑ @pokemonList.Count</h3>
            <p class="percentage">(@((score * 100 / pokemonList.Count))% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)</p>
        </div>
        <button class="btn-restart" @onclick="RestartGame">üîÑ –ù–∞—á–∞—Ç—å —Å –Ω–∞—á–∞–ª–∞</button>
    </div>
}
else
{
    <div class="game-container">
        <h3 class="game-title">G√¶t Pok√©monen!</h3>

        <div class="game-stats">
            <span>Progress: @totalAttempts / @pokemonList.Count</span>
            <span>Score: @score</span>
        </div>

        <div class="pokemon-image-wrapper">
            <PokemonImage Url="@pokemonList[currentIndex].Url" />
        </div>

        <p>Hvem er det?</p>

        <div class="answer-options">
            <button class="btn-answer" @onclick="() => CheckAnswer(correctName)" disabled="@(isCorrect != null)">@correctName</button>
            <button class="btn-answer" @onclick="() => CheckAnswer(wrongName)" disabled="@(isCorrect != null)">@wrongName</button>
        </div>

        @if (isCorrect != null)
        {
            <p class="result-message @(isCorrect == true ? "correct" : "incorrect")">
                @(isCorrect == true ? "‚úÖ Rigtigt!" : "‚ùå Forkert!")
            </p>
            <button class="btn-next" @onclick="NextPokemon">N√¶ste</button>
        }
    </div>
}

@code {
    private string correctName;
    private string wrongName;
    private string userAnswer;
    private bool? isCorrect;
    private int score = 0;
    private int totalAttempts = 0;
    private bool gameCompleted = false;

    private List<PokemonListItem> pokemonList = new();
    private int currentIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–∫–µ–º–æ–Ω–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 6 —à—Ç—É–∫)
        var response = await Http.GetFromJsonAsync<PokemonListResponse>(
            "https://pokeapi.co/api/v2/pokemon?limit=6");

        pokemonList = response?.Results ?? new List<PokemonListItem>();
        await GenerateQuestion();
        
        // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ - –±—É–¥–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞
    }

    // –ö–ª–∞—Å—Å –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ –ø–æ–∫–µ–º–æ–Ω–æ–≤
    public class PokemonListItem
    {
        public string Name { get; set; }
        public string Url { get; set; }
    }

    // –ö–ª–∞—Å—Å –¥–ª—è  API —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–æ–∫–µ–º–æ–Ω–æ–≤
    public class PokemonListResponse
    {
        public List<PokemonListItem> Results { get; set; }
    }

    private async Task GenerateQuestion()
    {
        var correctPokemon = pokemonList[currentIndex];
        correctName = correctPokemon.Name;

        var random = new Random();
        string wrong;
        do
        {
            var randomIndex = random.Next(0, pokemonList.Count);
            wrong = pokemonList[randomIndex].Name;
        } while (wrong == correctName);

        wrongName = wrong;
        isCorrect = null;
        userAnswer = null;
    }

    private async Task CheckAnswer(string answer)
    {
        if (isCorrect != null)
            return; // —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª, –Ω–µ –¥–∞—ë–º –Ω–∞–∂–∞—Ç—å –µ—â—ë —Ä–∞–∑

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –∫–ª–∏–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
        await JS.InvokeVoidAsync("gameAudio.playClickSound");

        userAnswer = answer;
        isCorrect = (answer == correctName);
        totalAttempts++;

        if (isCorrect == true)
        {
            score++;
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
            await JS.InvokeVoidAsync("gameAudio.playCorrectSound");
        }
        else
        {
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
            await JS.InvokeVoidAsync("gameAudio.playIncorrectSound");
        }
    }

    private async Task NextPokemon()
    {
        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
        await JS.InvokeVoidAsync("gameAudio.playNextSound");
        
        currentIndex++;

        if (currentIndex >= pokemonList.Count)
        {
            // –í—Å–µ –ø–æ–∫–µ–º–æ–Ω—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            gameCompleted = true;
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
            await JS.InvokeVoidAsync("gameAudio.playGameEndSound");
            return; // –í–∞–∂–Ω–æ! –í—ã—Ö–æ–¥–∏–º –∏–∑ –º–µ—Ç–æ–¥–∞, –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º GenerateQuestion()
        }

        await GenerateQuestion();
    }
    
    private async Task RestartGame()
    {
        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
        await JS.InvokeVoidAsync("gameAudio.playRestartSound");
    
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        gameCompleted = false;
        currentIndex = 0;
        totalAttempts = 0;
        score = 0;
    
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
        await GenerateQuestion();
    }
}
